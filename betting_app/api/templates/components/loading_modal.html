<!-- Loading Modal -->
<div id="loadingModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(10px);">
    <div class="loader"
        style="border: 4px solid rgba(255, 255, 255, 0.1); border-top: 4px solid #7FB8BE; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; box-shadow: 0 0 20px rgba(127, 184, 190, 0.3);">
    </div>
    <h3 style="color: #FFFFFF; margin-top: 24px; font-family: 'Outfit', sans-serif; font-size: 1.5rem;">Analyzing Market
        Data...</h3>
    <p style="color: #94A3B8; font-size: 1rem; margin-top: 8px;">Finding the best multi-bet combinations</p>
</div>

<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('loadingModal');

        // Check if we need to refresh (fresh session or stale data)
        const lastRefresh = localStorage.getItem('last_refresh_timestamp');
        const now = Date.now();
        const STALE_THRESHOLD = 5 * 60 * 1000; // 5 minutes

        // For demo purposes/user request: "ensure a complete data refresh is completed"
        // We will force it if it hasn't happened in this session recently
        if (!lastRefresh || (now - parseInt(lastRefresh)) > STALE_THRESHOLD) {
            startRefreshProcess();
        }

        // Expose function for manual triggering related to navigation if needed
        window.triggerSmartRefresh = startRefreshProcess;

        function startRefreshProcess() {
            modal.style.display = 'flex';

            // Trigger Backend Refresh
            fetch('/api/refresh', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log("Refresh complete:", data);
                    localStorage.setItem('last_refresh_timestamp', Date.now().toString());

                    // Simple reload to show new data
                    window.location.reload();
                })
                .catch(err => {
                    console.error("Refresh failed:", err);
                    alert("Error refreshing data. Please try again.");
                    modal.style.display = 'none';
                });
        }
    });
</script>