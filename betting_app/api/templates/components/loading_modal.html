<!-- Loading Modal -->
<div id="loadingModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(10px);">
    <div class="loader"
        style="border: 4px solid rgba(255, 255, 255, 0.1); border-top: 4px solid #7FB8BE; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; box-shadow: 0 0 20px rgba(127, 184, 190, 0.3);">
    </div>
    <h3 style="color: #FFFFFF; margin-top: 24px; font-family: 'Outfit', sans-serif; font-size: 1.5rem;">Analyzing Market
        Data...</h3>
    <p id="loadingModalSubtitle" style="color: #94A3B8; font-size: 1rem; margin-top: 8px;">Finding the best multi-bet combinations</p>
</div>

<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('loadingModal');
        const subtitle = document.getElementById('loadingModalSubtitle');

        const MODAL_STATUS_MESSAGES = [
            "Fetching live odds from bookmakers...",
            "Analyzing NRL, NBA & NFL markets...",
            "Building prop projections...",
            "Running sentiment analysis...",
            "Generating multi-bet combinations...",
            "Almost ready..."
        ];

        // Check if we need to refresh (fresh session or stale data)
        const lastRefresh = localStorage.getItem('last_refresh_timestamp');
        const now = Date.now();
        const STALE_THRESHOLD = 5 * 60 * 1000; // 5 minutes

        if (!lastRefresh || (now - parseInt(lastRefresh)) > STALE_THRESHOLD) {
            startRefreshProcess();
        }

        // Expose function for manual triggering
        window.triggerSmartRefresh = startRefreshProcess;

        function startRefreshProcess() {
            modal.style.display = 'flex';

            let msgIndex = 0;
            const msgInterval = setInterval(() => {
                msgIndex = (msgIndex + 1) % MODAL_STATUS_MESSAGES.length;
                subtitle.textContent = MODAL_STATUS_MESSAGES[msgIndex];
            }, 5000);

            const startTime = Date.now();
            const TIMEOUT = 90000;

            // Trigger Backend Refresh
            fetch('/api/refresh', { method: 'POST' })
                .then(response => response.json())
                .then(() => {
                    // Poll for completion instead of immediate reload
                    const pollInterval = setInterval(() => {
                        const elapsed = Date.now() - startTime;
                        if (elapsed >= TIMEOUT) {
                            clearInterval(pollInterval);
                            clearInterval(msgInterval);
                            localStorage.setItem('last_refresh_timestamp', Date.now().toString());
                            window.location.reload();
                            return;
                        }

                        fetch('/api/refresh/status')
                            .then(res => res.json())
                            .then(data => {
                                if (!data.refreshing) {
                                    clearInterval(pollInterval);
                                    clearInterval(msgInterval);
                                    localStorage.setItem('last_refresh_timestamp', Date.now().toString());
                                    window.location.reload();
                                }
                            })
                            .catch(() => {}); // Ignore transient poll errors
                    }, 3000);
                })
                .catch(err => {
                    console.error("Refresh failed:", err);
                    clearInterval(msgInterval);
                    alert("Error refreshing data. Please try again.");
                    modal.style.display = 'none';
                });
        }
    });
</script>